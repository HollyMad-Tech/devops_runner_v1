# RUNBOOK

## CI & Troubleshooting

This repository uses a **merge-only-if-green** pipeline with these gates:

1. **lint** — formatting and static checks (Python + Node, if present).
2. **unit** — runs pytest if `tests/` exists.
3. **contracts** — checks `/ping`, `/plan`, `/exec` against `APP_BASE_URL` and validates JSON schemas in `tools/*.schema.json` or `schema/*.schema.json`.
4. **e2e** — smokes for Research Brief v1 and DevOps Runner v1 (`ci/scripts/smoke.sh`).
5. **canary** — runs canary set from `canaries/cases.jsonl` (`ci/scripts/run_canaries.py`).

**On any failure:** the pipeline blocks merge, uploads logs/artifacts, and writes an incident bundle under `memory/incidents/<run_id>_<attempt>`.

**Artifacts:**
- `artifacts/logs/*` — logs per stage
- `artifacts/metrics/*` — metrics snapshots (`*.jsonl`, `kpi_summary.txt`)
- `artifacts/audit/*` — latest audit bundle (if produced by your tools)

**KPI Summary:** generated by `ci/scripts/kpi_summary.py` and printed at the end.

### Local Reproduction
```bash
bash ci/scripts/run_lint.sh
pytest -q
export APP_BASE_URL=http://127.0.0.1:8765 && bash ci/scripts/contracts.sh
bash ci/scripts/smoke.sh
bash ci/scripts/canary.sh canaries/cases.jsonl
```

### Strict Mode
Set `CI_STRICT=true` (repo variable/secret) to fail when required resources are missing.

### Make failures visible
Check the CI Artifacts tab for `logs-*`, `audit-bundle`, `incident-bundle`, and `kpi-summary`.
## Canary suite & KPIs

Structure
- tests/canary/rb/*.jsonl — ≈15 Research Brief canaries.
- tests/canary/devops/*.jsonl — ≈10 DevOps canaries.
- tests/kpi_asserts.py — KPI helpers (Plan-Adherence, Tool-Success, TTFT, p95).
- configs/canary_map.json — categories, weights, thresholds.
- metrics/canary_metrics.jsonl — per-run feed.

How to run
- Optional env: KPI_PLAN_ADHERENCE=0.90 KPI_TOOL_SUCCESS=0.95 KPI_TTFT_MS=300 KPI_P95_DRY_MS=2000 KPI_P95_RUN_MS=6000
- Run: python -m pytest -q

CI gates
- Build fails if any KPI assert fails (per-case or aggregate).
- Keep failures as regression guards.
- When all green on full set → tag v0.2.0 (pilot-demo ready).
